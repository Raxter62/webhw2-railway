<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA ç’°å¢ƒè¨ºæ–·å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }
        .result {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
        }
        .result.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .result.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .value {
            font-family: 'Courier New', monospace;
            color: #212529;
            word-break: break-all;
        }
        .icon {
            font-size: 24px;
            margin-right: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .conclusion {
            margin-top: 20px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 12px;
            border: 2px solid #667eea;
        }
        .conclusion h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .steps {
            margin-top: 15px;
            padding-left: 20px;
        }
        .steps li {
            margin: 8px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PWA ç’°å¢ƒè¨ºæ–·å·¥å…·</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 20px;">
            æª¢æŸ¥ä½ çš„ç¶²é æ˜¯å¦æ”¯æ´ PWA
        </p>

        <div id="results"></div>
        
        <button id="testBtn" onclick="runTest()">é–‹å§‹æª¢æ¸¬</button>
        <button id="testSW" onclick="testServiceWorker()" style="display: none; margin-top: 10px; background: #28a745;">
            æ¸¬è©¦è¨»å†Š Service Worker
        </button>
        
        <div id="conclusion" style="display: none;"></div>
    </div>

    <script>
        function runTest() {
            const results = document.getElementById('results');
            const conclusion = document.getElementById('conclusion');
            const testBtn = document.getElementById('testBtn');
            const testSWBtn = document.getElementById('testSW');
            
            results.innerHTML = '';
            conclusion.style.display = 'none';
            testBtn.disabled = true;
            testBtn.textContent = 'æª¢æ¸¬ä¸­...';
            
            // æ”¶é›†æ‰€æœ‰æª¢æ¸¬çµæœ
            const checks = [];
            
            // 1. åŸºæœ¬è³‡è¨Š
            addResult('ğŸŒ ç•¶å‰ç¶²å€', location.href, 'success');
            addResult('ğŸ“¡ å”è­°', location.protocol, 
                location.protocol === 'https:' ? 'success' : 'error');
            addResult('ğŸ–¥ï¸ ä¸»æ©Ÿåç¨±', location.hostname, 'success');
            
            // 2. å®‰å…¨ä¸Šä¸‹æ–‡æª¢æŸ¥
            const isSecure = window.isSecureContext;
            checks.push({
                name: 'å®‰å…¨ä¸Šä¸‹æ–‡',
                pass: isSecure,
                critical: true
            });
            addResult('ğŸ”’ å®‰å…¨ä¸Šä¸‹æ–‡ (isSecureContext)', 
                isSecure ? 'âœ… æ˜¯' : 'âŒ å¦', 
                isSecure ? 'success' : 'error');
            
            // 3. Service Worker æ”¯æ´
            const hasSW = 'serviceWorker' in navigator;
            checks.push({
                name: 'Service Worker',
                pass: hasSW,
                critical: true
            });
            addResult('âš™ï¸ Service Worker æ”¯æ´', 
                hasSW ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´', 
                hasSW ? 'success' : 'error');
            
            // 4. å…§ç¶²åˆ¤æ–·
            const isLocalhost = location.hostname === 'localhost' || 
                              location.hostname === '127.0.0.1';
            const isPrivateIP = /^(192\.168|10\.|172\.(1[6-9]|2[0-9]|3[01])\.)/.test(location.hostname);
            const isSchoolIP = /^140\.138\./.test(location.hostname);
            
            addResult('ğŸ  Localhost', 
                isLocalhost ? 'âœ… æ˜¯' : 'âŒ å¦', 
                isLocalhost ? 'success' : 'warning');
            addResult('ğŸ¢ ç§æœ‰ IP (192.168/10.x)', 
                isPrivateIP ? 'âœ… æ˜¯' : 'âŒ å¦', 
                isPrivateIP ? 'success' : 'warning');
            addResult('ğŸ“ å­¸æ ¡ IP (140.138.x.x)', 
                isSchoolIP ? 'âœ… æ˜¯' : 'âŒ å¦', 
                isSchoolIP ? 'success' : 'warning');
            
            // 5. ç€è¦½å™¨è³‡è¨Š
            addResult('ğŸŒ ç€è¦½å™¨', navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/)?.[0] || 'Unknown', 'success');
            
            // 6. PWA åŠŸèƒ½æ”¯æ´
            addResult('ğŸ“± Manifest æ”¯æ´', 
                'onbeforeinstallprompt' in window ? 'âœ… æ”¯æ´' : 'âš ï¸ å¯èƒ½ä¸æ”¯æ´', 
                'onbeforeinstallprompt' in window ? 'success' : 'warning');
            
            // 7. å„²å­˜ API
            addResult('ğŸ’¾ localStorage', 
                typeof localStorage !== 'undefined' ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨', 
                typeof localStorage !== 'undefined' ? 'success' : 'error');
            
            // 8. ç¶²è·¯ç‹€æ…‹
            addResult('ğŸ“¶ ç¶²è·¯ç‹€æ…‹', 
                navigator.onLine ? 'âœ… ç·šä¸Š' : 'âŒ é›¢ç·š', 
                navigator.onLine ? 'success' : 'warning');
            
            // ç”Ÿæˆçµè«–
            setTimeout(() => {
                generateConclusion(checks, isSecure, hasSW);
                testBtn.disabled = false;
                testBtn.textContent = 'é‡æ–°æª¢æ¸¬';
                
                // å¦‚æœåŸºæœ¬æ¢ä»¶æ»¿è¶³ï¼Œé¡¯ç¤º SW æ¸¬è©¦æŒ‰éˆ•
                if (isSecure && hasSW) {
                    testSWBtn.style.display = 'block';
                }
            }, 500);
        }
        
        function addResult(label, value, type = 'success') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `
                <div class="label">${label}</div>
                <div class="value">${value}</div>
            `;
            results.appendChild(div);
        }
        
        function generateConclusion(checks, isSecure, hasSW) {
            const conclusion = document.getElementById('conclusion');
            conclusion.style.display = 'block';
            
            const allPass = checks.every(c => c.pass);
            
            let html = '<h2>';
            let message = '';
            let steps = [];
            
            if (allPass) {
                html += 'ğŸ‰ æ­å–œï¼ä½ çš„ç’°å¢ƒæ”¯æ´ PWAï¼';
                message = 'æ‰€æœ‰å¿…è¦æ¢ä»¶éƒ½å·²æ»¿è¶³ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ Service Worker å’Œé›¢ç·šåŠŸèƒ½ã€‚';
                steps = [
                    'é»æ“Šä¸‹æ–¹ã€Œæ¸¬è©¦è¨»å†Š Service Workerã€æŒ‰éˆ•',
                    'ç¢ºèªè¨»å†ŠæˆåŠŸå¾Œï¼Œé‡æ–°æ•´ç†é é¢',
                    'åœ¨ Chrome DevTools > Application > Service Workers æŸ¥çœ‹ç‹€æ…‹',
                    'æ¸¬è©¦é›¢ç·šæ¨¡å¼ï¼ˆDevTools > Network > Offlineï¼‰'
                ];
            } else if (!isSecure) {
                html += 'âŒ ç„¡æ³•ä½¿ç”¨å®Œæ•´ PWA åŠŸèƒ½';
                message = '<strong>åŸå› ï¼š</strong>ä½ çš„ç¶²å€ä½¿ç”¨ HTTP å”è­°ï¼Œä¸”ä¸ç¬¦åˆç€è¦½å™¨çš„å®‰å…¨ä¾‹å¤–æ¢ä»¶ã€‚<br><br>' +
                         '<strong>140.138.x.x é›–ç„¶æ˜¯å­¸æ ¡å…§ç¶²ï¼Œä½†ç€è¦½å™¨ä»è¦–ç‚ºå…¬é–‹ IPï¼Œå¿…é ˆä½¿ç”¨ HTTPSã€‚</strong>';
                steps = [
                    '<strong>æ–¹æ¡ˆ 1 (æ¨è–¦)ï¼š</strong>ä½¿ç”¨ ngrok å»ºç«‹ HTTPS é€šé“',
                    '<strong>æ–¹æ¡ˆ 2ï¼š</strong>è«‹ç³»çµ±ç®¡ç†å“¡åœ¨ä¼ºæœå™¨ä¸Šè¨­å®š HTTPS',
                    '<strong>æ–¹æ¡ˆ 3ï¼š</strong>ä½¿ç”¨é™ç´šæ–¹æ¡ˆï¼ˆåƒ…ä¿ç•™åŸºæœ¬åŠŸèƒ½ï¼‰'
                ];
            } else if (!hasSW) {
                html += 'âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker';
                message = 'è«‹æ›´æ–°ç€è¦½å™¨è‡³æœ€æ–°ç‰ˆæœ¬ï¼Œæˆ–ä½¿ç”¨ Chrome/Edge/Firefox ç­‰ç¾ä»£ç€è¦½å™¨ã€‚';
                steps = [
                    'æ›´æ–°ç€è¦½å™¨åˆ°æœ€æ–°ç‰ˆæœ¬',
                    'å»ºè­°ä½¿ç”¨ Chrome 89+ æˆ– Edge 89+',
                    'ç¢ºèªç€è¦½å™¨æœªåœç”¨ Service Worker åŠŸèƒ½'
                ];
            }
            
            html += '</h2><p style="margin-top: 10px; line-height: 1.6;">' + message + '</p>';
            
            if (steps.length > 0) {
                html += '<h3 style="margin-top: 15px; color: #495057;">ğŸ“‹ å»ºè­°æ­¥é©Ÿï¼š</h3><ol class="steps">';
                steps.forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += '</ol>';
            }
            
            conclusion.innerHTML = html;
        }
        
        async function testServiceWorker() {
            const testSWBtn = document.getElementById('testSW');
            testSWBtn.disabled = true;
            testSWBtn.textContent = 'è¨»å†Šä¸­...';
            
            try {
                // å‰µå»ºä¸€å€‹ç°¡å–®çš„ test-sw.js
                const swCode = `
                    self.addEventListener('install', (e) => {
                        console.log('Test SW: Installed');
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', (e) => {
                        console.log('Test SW: Activated');
                        e.waitUntil(self.clients.claim());
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(fetch(e.request));
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                
                const registration = await navigator.serviceWorker.register(swURL);
                
                addResult('âœ… Service Worker è¨»å†Š', 'æˆåŠŸï¼', 'success');
                addResult('ğŸ“ Scope', registration.scope, 'success');
                
                testSWBtn.textContent = 'âœ… è¨»å†ŠæˆåŠŸï¼';
                testSWBtn.style.background = '#28a745';
                
                alert('ğŸ‰ Service Worker è¨»å†ŠæˆåŠŸï¼\n\nä½ çš„ç’°å¢ƒå®Œå…¨æ”¯æ´ PWAï¼\n\nç¾åœ¨å¯ä»¥ä½¿ç”¨å®Œæ•´çš„é›¢ç·šåŠŸèƒ½äº†ã€‚');
                
            } catch (error) {
                addResult('âŒ Service Worker è¨»å†Š', `å¤±æ•—: ${error.message}`, 'error');
                testSWBtn.textContent = 'âŒ è¨»å†Šå¤±æ•—';
                testSWBtn.style.background = '#dc3545';
                testSWBtn.disabled = false;
                
                alert('âŒ Service Worker è¨»å†Šå¤±æ•—ï¼\n\néŒ¯èª¤ï¼š' + error.message + '\n\né€™ä»£è¡¨ä½ çš„ç’°å¢ƒä¸æ”¯æ´ PWAï¼Œéœ€è¦æ”¹ç”¨ HTTPSã€‚');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æ¸¬
        window.addEventListener('load', runTest);
    </script>
</body>
</html>